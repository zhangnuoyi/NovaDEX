# MetaNodeStake 项目功能文档

## 1. 项目概述

MetaNodeStake 是一个基于以太坊区块链的去中心化质押系统，允许用户质押多种资产（包括 ETH 和 ERC20 代币）以获取 MetaNode 代币作为奖励。系统采用模块化设计，支持多质押池、动态奖励分配、权限管理等核心功能。

## 2. 核心功能

### 2.1 多质押池支持
- **ETH 质押池**：专为 ETH 资产设计的质押池
- **ERC20 代币质押池**：支持任意 ERC20 代币的质押池
- **动态池管理**：管理员可动态添加、配置和调整质押池参数

### 2.2 奖励机制
- **区块奖励**：按区块分配 MetaNode 代币奖励
- **权重分配**：不同质押池可设置不同权重，影响奖励分配比例
- **自动计算**：系统自动计算每个质押者的待领取奖励
- **复利计算**：未领取的奖励会自动计入下一期计算

### 2.3 质押与解质押
- **灵活质押**：支持用户随时质押资产，无锁定期限制
- **解质押请求**：用户提交解质押请求后，需等待指定区块数才能完成解质押
- **分批解质押**：支持用户多次提交解质押请求，实现分批提取

### 2.4 奖励领取
- **手动领取**：用户可随时领取已结算的奖励
- **安全转账**：使用 SafeERC20 实现安全的代币转账

### 2.5 权限管理
- **管理员角色**：拥有最高权限，可配置系统参数
- **升级角色**：负责合约升级
- **暂停角色**：可暂停/恢复系统功能

### 2.6 可升级性
- **UUPS 代理模式**：支持合约平滑升级，无需用户重新交互
- **权限控制**：升级操作需经过权限验证

### 2.7 安全机制
- **暂停功能**：可暂停奖励领取和解质押操作，应对紧急情况
- **溢出保护**：所有数学运算均采用安全的乘法和除法
- **访问控制**：关键功能需验证调用者权限

## 3. 技术架构

### 3.1 合约结构
- **MetNode.sol**：基础 ERC20 代币合约，用于系统奖励
- **MetaNodeStake.sol**：核心质押系统合约，实现所有质押逻辑

### 3.2 依赖库
- **OpenZeppelin Contracts**：提供 ERC20、AccessControl、SafeERC20 等基础功能
- **OpenZeppelin Contracts Upgradeable**：提供可升级合约的基础框架

### 3.3 核心数据结构

#### Pool 结构体
```solidity
struct Pool {
    address stTokenAddress; // 质押代币地址
    uint256 poolWeight;     // 池权重
    uint256 lastRewardBlock;// 上次奖励块号
    uint256 accMetaNodePerShare; // 每个质押代币的 MetaNode 奖励比例
    uint256 stTokenAmount;  // 总质押数量
    uint256 minStTokenAmount; // 最小质押数量
    uint256 unStakingBlock; // 解质押所需区块数
}
```

#### User 结构体
```solidity
struct User {
    uint256 stAmount;       // 质押数量
    uint256 finishedMetaNode; // 已结算奖励
    uint256 pendingMetaNode;   // 待领取奖励
    UnstakeRequest[] unstakeRequests; // 解质押请求队列
}
```

#### UnstakeRequest 结构体
```solidity
struct UnstakeRequest {
    uint256 amount;         // 解质押数量
    uint256 unstakingBlock; // 解质押可执行区块号
}
```

## 4. 系统流程

### 4.1 质押流程
1. 用户调用 `depositETH` 或 `deposit` 函数
2. 系统验证质押数量是否满足最小要求
3. 系统更新质押池状态和用户信息
4. 系统计算并累积用户的待领取奖励

### 4.2 奖励领取流程
1. 用户调用 `withdraw` 函数
2. 系统更新质押池状态
3. 系统计算用户的待领取奖励
4. 系统将奖励转账给用户

### 4.3 解质押流程
1. 用户调用 `unstake` 函数
2. 系统验证用户质押余额
3. 系统更新质押池状态和用户信息
4. 系统创建解质押请求，设置可执行时间
5. 等待指定区块数后，用户调用 `claim` 函数完成解质押

## 5. 系统参数

| 参数名 | 类型 | 描述 |
|--------|------|------|
| startBlock | uint256 | 系统开始分配奖励的区块号 |
| endBlock | uint256 | 系统结束分配奖励的区块号 |
| MetaNodePreBlock | uint256 | 每个区块的 MetaNode 奖励数量 |
| totalPoolWeight | uint256 | 所有质押池的总权重 |
| claimPaused | bool | 是否暂停解质押操作 |
| withdrawPaused | bool | 是否暂停奖励领取操作 |

## 6. 权限角色

| 角色名 | 描述 |
|--------|------|
| DEFAULT_ADMIN_ROLE | 默认管理员角色，可分配其他角色 |
| UPGRADER_ROLE | 合约升级角色，负责合约升级 |
| PAUSER_ROLE | 暂停角色，可暂停/恢复系统功能 |
| ADMIN_ROLE | 系统管理员角色，可配置系统参数 |

## 7. 事件列表

### 系统配置事件
- `SetMetaNode`：设置 MetaNode 代币合约
- `PauseWithdraw`：暂停奖励领取
- `UnpauseWithdraw`：恢复奖励领取
- `PauseClaim`：暂停解质押
- `UnpauseClaim`：恢复解质押
- `SetStartBlock`：设置开始区块
- `SetEndBlock`：设置结束区块
- `SetMetaNodePreBlock`：设置区块奖励数量

### 质押池事件
- `AddPool`：添加新质押池
- `SetPoolWeight`：设置质押池权重
- `UpdatePool`：更新质押池信息

### 用户操作事件
- `Deposit`：用户质押资产
- `Withdraw`：用户领取奖励
- `Claim`：用户完成解质押
- `RequestUnstake`：用户提交解质押请求
- `Unstake`：用户完成解质押

## 8. 安全考虑

### 8.1 已知风险
- **价格波动风险**：质押资产价格波动可能影响用户收益
- **智能合约风险**：尽管采用了多种安全措施，智能合约仍存在潜在漏洞风险

### 8.2 缓解措施
- **多重测试**：合约需经过全面测试，包括单元测试、集成测试和渗透测试
- **审计报告**：建议聘请专业审计机构进行合约审计
- **紧急暂停**：系统提供紧急暂停功能，可在发现问题时快速停止关键操作

## 9. 未来规划

- 支持更多资产类型（如 NFT）
- 实现自动复投功能
- 增加质押保险机制
- 支持跨链质押
- 优化奖励分配算法

## 10. 总结

MetaNodeStake 是一个功能完善、安全可靠的去中心化质押系统，为用户提供了灵活的质押选择和稳定的奖励机制。系统采用模块化设计，支持多质押池、动态奖励分配和灵活的权限管理，具有良好的可扩展性和可维护性。