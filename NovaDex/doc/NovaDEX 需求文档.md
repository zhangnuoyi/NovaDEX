# NovaDEX 需求文档

## 1. 文档概述

本需求文档基于 NovaDEX 技术方案设计文档，对项目的所有功能点进行了细化和确认，为开发团队提供明确的功能开发指导。

## 2. 功能点细化

### 2.1 Factory 合约功能

#### 2.1.1 代币排序功能

**功能描述**：对输入的两个代币地址进行排序，确保 token0 < token1

**输入参数**：
- tokenA: 代币A地址
- tokenB: 代币B地址

**输出参数**：
- token0: 排序后的第一个代币地址
- token1: 排序后的第二个代币地址

**验收标准**：
- 无论输入顺序如何，始终返回 token0 < token1
- 相同地址输入时返回错误

#### 2.1.2 池创建功能

**功能描述**：创建新的流动性池合约

**输入参数**：
- tokenA: 代币A地址
- tokenB: 代币B地址
- tickLower: 价格区间下限
- tickUpper: 价格区间上限
- fee: 交易费率

**输出参数**：
- pool: 新创建的池合约地址

**验收标准**：
- 创建的池地址可预测（使用 CREATE2）
- 池包含正确的参数（代币地址、费率、价格区间）
- 已存在的池不会重复创建
- 发出 PoolCreated 事件

#### 2.1.3 池查询功能

**功能描述**：根据代币地址和索引查询池地址

**输入参数**：
- tokenA: 代币A地址
- tokenB: 代币B地址
- index: 池索引

**输出参数**：
- pool: 池合约地址

**验收标准**：
- 正确返回已创建池的地址
- 不存在的池返回0地址

### 2.2 Pool 合约功能

#### 2.2.1 池初始化功能

**功能描述**：初始化池的初始价格

**输入参数**：
- sqrtPriceX96: 初始价格的平方根（Q64.96格式）

**输出参数**：无

**验收标准**：
- 池的 sqrtPriceX96 和 tick 被正确设置
- 初始价格在指定的价格区间内
- 只能初始化一次

#### 2.2.2 流动性提供功能

**功能描述**：在指定价格区间内提供流动性

**输入参数**：
- recipient: 流动性接收地址
- amount: 流动性数量
- data: 回调数据

**输出参数**：
- amount0: 提供的代币0数量
- amount1: 提供的代币1数量

**验收标准**：
- 流动性被正确添加
- 发出 Mint 事件
- 调用 mintCallback 回调
- 验证资金已正确转移

#### 2.2.3 流动性提取功能

**功能描述**：提取指定数量的流动性

**输入参数**：
- amount: 要提取的流动性数量

**输出参数**：
- amount0: 提取的代币0数量
- amount1: 提取的代币1数量

**验收标准**：
- 流动性被正确减少
- 发出 Burn 事件
- 提取的代币数量计算正确

#### 2.2.4 手续费收取功能

**功能描述**：收取累积的交易手续费

**输入参数**：
- recipient: 手续费接收地址
- amount0Requested: 请求的代币0手续费数量
- amount1Requested: 请求的代币1手续费数量

**输出参数**：
- amount0: 实际收取的代币0手续费数量
- amount1: 实际收取的代币1手续费数量

**验收标准**：
- 手续费被正确转移
- 发出 Collect 事件
- 不超过可用手续费数量

#### 2.2.5 代币交换功能

**功能描述**：在池中进行代币交换

**输入参数**：
- recipient: 接收地址
- zeroForOne: 交易方向（true表示token0→token1）
- amountSpecified: 指定的交易数量
- sqrtPriceLimitX96: 价格限制
- data: 回调数据

**输出参数**：
- amount0: token0的变化量
- amount1: token1的变化量

**验收标准**：
- 价格被正确更新
- 代币被正确转移
- 发出 Swap 事件
- 调用 swapCallback 回调
- 验证资金已正确转移

### 2.3 PositionManager 合约功能

#### 2.3.1 头寸创建功能

**功能描述**：创建新的流动性头寸

**输入参数**：
- token0: 代币0地址
- token1: 代币1地址
- fee: 交易费率
- tickLower: 价格区间下限
- tickUpper: 价格区间上限
- amount0Desired: 期望提供的代币0数量
- amount1Desired: 期望提供的代币1数量
- amount0Min: 最小接受的代币0数量
- amount1Min: 最小接受的代币1数量
- recipient: 头寸接收地址
- deadline: 交易截止时间

**输出参数**：
- tokenId: 头寸的NFT ID
- liquidity: 创建的流动性数量
- amount0: 实际提供的代币0数量
- amount1: 实际提供的代币1数量

**验收标准**：
- 创建新的ERC721 NFT
- 流动性被正确添加到池
- 发出 Transfer 事件
- 验证资金已正确转移

#### 2.3.2 头寸销毁功能

**功能描述**：销毁指定的流动性头寸

**输入参数**：
- tokenId: 头寸的NFT ID
- amount: 要销毁的流动性数量

**输出参数**：
- amount0: 提取的代币0数量
- amount1: 提取的代币1数量

**验收标准**：
- 头寸的流动性被正确减少
- NFT被正确销毁
- 发出 Transfer 事件
- 验证资金已正确返回

#### 2.3.3 头寸手续费收取功能

**功能描述**：收取指定头寸的累积手续费

**输入参数**：
- tokenId: 头寸的NFT ID
- recipient: 手续费接收地址
- amount0Requested: 请求的代币0手续费数量
- amount1Requested: 请求的代币1手续费数量

**输出参数**：
- amount0: 实际收取的代币0手续费数量
- amount1: 实际收取的代币1手续费数量

**验收标准**：
- 手续费被正确转移
- 验证资金已正确返回

#### 2.3.4 头寸信息查询功能

**功能描述**：查询指定头寸的详细信息

**输入参数**：
- tokenId: 头寸的NFT ID

**输出参数**：
- owner: 头寸所有者地址
- token0: 代币0地址
- token1: 代币1地址
- fee: 交易费率
- tickLower: 价格区间下限
- tickUpper: 价格区间上限
- liquidity: 流动性数量
- feeGrowthInside0LastX128: 代币0手续费增长
- feeGrowthInside1LastX128: 代币1手续费增长
- tokensOwed0: 待领取的代币0手续费
- tokensOwed1: 待领取的代币1手续费

**验收标准**：
- 返回正确的头寸信息
- 不存在的tokenId返回默认值

### 2.4 SwapRouter 合约功能

#### 2.4.1 精确输入交易功能

**功能描述**：指定输入代币数量，计算输出代币数量

**输入参数**：
- tokenIn: 输入代币地址
- tokenOut: 输出代币地址
- fee: 交易费率
- recipient: 接收地址
- deadline: 交易截止时间
- amountIn: 输入代币数量
- amountOutMinimum: 最小接受的输出代币数量
- sqrtPriceLimitX96: 价格限制

**输出参数**：
- amountOut: 实际输出的代币数量

**验收标准**：
- 输出代币数量不小于 amountOutMinimum
- 交易在截止时间前完成
- 验证资金已正确转移

#### 2.4.2 精确输出交易功能

**功能描述**：指定输出代币数量，计算输入代币数量

**输入参数**：
- tokenIn: 输入代币地址
- tokenOut: 输出代币地址
- fee: 交易费率
- recipient: 接收地址
- deadline: 交易截止时间
- amountOut: 输出代币数量
- amountInMaximum: 最大接受的输入代币数量
- sqrtPriceLimitX96: 价格限制

**输出参数**：
- amountIn: 实际输入的代币数量

**验收标准**：
- 输入代币数量不超过 amountInMaximum
- 交易在截止时间前完成
- 验证资金已正确转移

#### 2.4.3 交易报价功能

**功能描述**：模拟交易，计算预期的输出/输入代币数量

**输入参数**：
- tokenIn: 输入代币地址
- tokenOut: 输出代币地址
- fee: 交易费率
- amountIn: 输入代币数量（精确输入）或 amountOut: 输出代币数量（精确输出）
- sqrtPriceLimitX96: 价格限制

**输出参数**：
- amountOut: 预期输出的代币数量（精确输入）或 amountIn: 预期输入的代币数量（精确输出）

**验收标准**：
- 返回的数量与实际交易结果一致
- 不影响实际的池状态

### 2.5 数学库功能

#### 2.5.1 价格计算功能

**功能描述**：根据 sqrtPriceX96 计算实际价格，或根据价格计算 sqrtPriceX96

**输入参数**：
- sqrtPriceX96: 平方根价格（Q64.96格式）

**输出参数**：
- price: 实际价格

**验收标准**：
- 价格计算精确
- 不出现溢出

#### 2.5.2 Tick 转换功能

**功能描述**：根据价格或 sqrtPriceX96 计算对应的 tick 值

**输入参数**：
- price: 实际价格 或 sqrtPriceX96: 平方根价格

**输出参数**：
- tick: 对应的 tick 值

**验收标准**：
- Tick 值计算精确
- 边界情况处理正确

#### 2.5.3 流动性计算功能

**功能描述**：根据代币数量和价格计算流动性

**输入参数**：
- amount0: 代币0数量
- amount1: 代币1数量
- sqrtPriceX96: 当前价格的平方根
- sqrtPriceLowerX96: 价格区间下限的平方根
- sqrtPriceUpperX96: 价格区间上限的平方根

**输出参数**：
- liquidity: 流动性数量

**验收标准**：
- 流动性计算精确
- 边界情况处理正确

#### 2.5.4 交易计算功能

**功能描述**：计算交易的价格变化和代币数量

**输入参数**：
- sqrtPriceX96: 当前价格的平方根
- sqrtPriceTargetX96: 目标价格的平方根
- liquidity: 可用流动性
- amountRemaining: 剩余交易数量
- fee: 交易费率

**输出参数**：
- sqrtPriceNextX96: 新的平方根价格
- amountIn: 输入代币数量
- amountOut: 输出代币数量
- feeAmount: 手续费数量

**验收标准**：
- 交易计算精确
- 手续费计算正确

## 3. 非功能需求

### 3.1 安全性需求

1. 所有外部输入必须经过验证
2. 回调机制必须安全，防止重入攻击
3. 数学计算必须经过严格验证，防止溢出
4. 权限控制必须适当，避免未授权访问
5. 必须处理所有可能的边界条件

### 3.2 性能需求

1. 交易 gas 费用必须低于行业平均水平
2. 数学计算必须高效，避免不必要的计算
3. 存储操作必须优化，减少 gas 消耗

### 3.3 可扩展性需求

1. 架构必须模块化，便于未来扩展
2. 接口必须设计清晰，支持功能扩展
3. 必须考虑未来支持更多代币类型和链

### 3.4 可用性需求

1. 合约必须易于集成，提供清晰的 API
2. 文档必须完整，便于开发者使用
3. 必须提供足够的错误信息，便于调试

## 4. 验收标准

### 4.1 单元测试

- 每个功能点必须有对应的单元测试
- 单元测试覆盖率必须达到 90% 以上
- 所有单元测试必须通过

### 4.2 集成测试

- 合约之间的交互必须有对应的集成测试
- 集成测试必须覆盖所有主要业务流程
- 所有集成测试必须通过

### 4.3 安全审计

- 必须通过第三方安全审计
- 审计发现的问题必须全部修复
- 必须通过安全漏洞扫描

### 4.4 性能测试

- 交易 gas 费用必须符合性能需求
- 高并发情况下系统必须稳定
- 数学计算性能必须符合要求

## 5. 后续开发计划

根据细化的需求文档，后续开发阶段的详细计划如下：

### 5.1 核心功能开发阶段（2周）

1. 实现数学库（1周）
2. 实现 Factory 合约（2天）
3. 实现 Pool 合约（3天）
4. 实现 PositionManager 合约（3天）
5. 实现 SwapRouter 合约（3天）

### 5.2 测试与审计阶段（2周）

1. 编写单元测试（1周）
2. 编写集成测试（3天）
3. 第三方安全审计（3天）
4. 修复测试和审计发现的问题（1天）

### 5.3 部署与上线阶段（1周）

1. 部署到测试网（2天）
2. 测试网测试（2天）
3. 部署到主网（1天）
4. 主网验证（2天）

### 5.4 运营与维护阶段（持续）

1. 监控系统性能
2. 处理用户反馈
3. 实现功能扩展
4. 定期安全审计

## 6. 附录

### 6.1 术语定义

| 术语 | 解释 |
|------|------|
| DEX | 去中心化交易所（Decentralized Exchange） |
| AMM | 自动做市商（Automated Market Maker） |
| LP | 流动性提供者（Liquidity Provider） |
| Tick | 价格刻度，用于表示价格区间的整数标识 |
| sqrtPriceX96 | Q64.96 格式的平方根价格 |

### 6.2 参考文档

- NovaDEX 技术方案设计文档
- Uniswap V3 白皮书
