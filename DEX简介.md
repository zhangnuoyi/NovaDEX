# DEX简介

### 为什么要学习DEX

1. **构建链上金融体系**

   DEX作为Web3金融体系的重要组成部分，与其他DeFi协议相互协作，共同构建了一个完整的链上金融生态系统。它可以与借贷协议、保险协议、衍生品协议等进行集成，实现资产跨链跳转、协议间激励博弈等功能，为用户提供更加丰富和多元化的金融服务

2. **推动行业创新与竞争**

   DEX的发展促使整个Web3行业不断创新和竞争。为了吸引用户和流动性，各个DEX不断进行技术创新和功能优化，降低交易成本，提高交易效率和安全性。同时，DEX之间的竞争也推动了行业的发展，使得整个Web3金融市场更加健康和活跃



### 什么是DEX

在加密世界中，Uniswap 和 Blur 是广为人知的两个去中心化交易所典型代表。通常情况下，Uniswap 主要进行代币交易，而 Blur 聚焦于 NFT 交易。不过，规则并非绝对，如今 Uniswap 也具备了交易 NFT 的功能。



- **如何定义去中心化交易所**

  那么，怎样判断一个交易所是去中心化交易所呢？其实，最关键的一点在于其交易是否通过智能合约处理，而非借助中心化的服务器。若交易由智能合约来处理，那么这个交易所就属于去中心化交易所。

  以 Uniswap 为例，当用户进行代币交易时，网站会提示用户连接钱包，经用户使用钱包签名交易后，最终由智能合约完成整个交易过程。在这个流程里，Uniswap 不存在自己的服务器来处理交易，完全依靠智能合约运作。想象一下，即便 Uniswap 的网站服务器出现故障，用户依然能够通过调用智能合约来完成交易。

  与去中心化交易所相对的，是像 币安、OKX 这类中心化交易所。在使用这类交易所时，用户需要完成邮箱注册、实名认证、绑定手机、设置密码等一系列操作，随后借助币安的服务器完成交易。由于这种交易所的服务器是中心化的，一旦币安的服务器出现问题，用户便无法正常交易。



- **去中心化交易所的必要性**

  当下，中心化交易所貌似功能更强大，交易速度和效率更高。那么，为何还需要去中心化交易所呢？答案显然易见，除了能避免因服务器故障影响交易外，去中心化交易所还有诸多显著优势。

  - **安全性保障**

    很多人首先会想到的就是安全性。在去中心化交易所中，资产由用户自行掌控，相对而言更加安全。这的确是一项重要优势，但并非唯一优势。就像 2022 年 11 月，全球第二大加密货币交易所 FTX 破产，这一事件震惊了整个行业。美国证券交易委员会（SEC）经过调查发现，自FTX创立起，其创始人就开始挪用客户资金。这种中心化控制下的安全问题，是去中心化交易所极力避免的。

  - **利率与手续费自主性**

    除了安全问题，中心化交易所还存在利率和手续费控制方面的弊端。在大型的银行和金融机构，也会对金融体系实现一定程度的掌控。而 DeFi（去中心化金融）正是为了打破这种中心化控制而兴起，去中心化交易所正是 DeFi 中的关键组成部分。

  - **高效与透明性**

    去中心化交易所具备更高的效率和透明度，它能够 24 小时不间断地运作，且交易公开透明。同时，它更容易与其他 DeFi 项目进行整合，例如与借贷协议整合，从而实现更多样化的金融服务。这些服务是通过开放且透明的智能合约来实现的，这不仅降低了搭建金融服务的成本，还大大提高了效率。

    举个例子，假如某个项目想要发行自己的资产供用户交易。在传统的中心化交易所，这可能需要与交易所签订繁琐的合同，并让研发人员与系统进行对接，整个流程复杂且不可靠。然而在去中心化交易所中，只需要简单两步即可。第一步，将资产通过智能合约发布到链上；第二步，把资产加入去中心化交易所的流动性池，这样用户就能进行交易了。

  - **塑造金融新格局**

    随着 DeFi 的不断发展，金融服务将变得愈发便捷，区块链技术也必将重塑金融服务的格局。作为整个去中心化金融体系下的重要基础设施，去中心化交易所的重要性不言而喻。

  

- **实现去中心化交易所的关键考量**

  要实现一个去中心化交易所，除了用户操作页面外，智能合约是重中之重。智能合约承担着处理用户交易请求、保障交易安全与透明的重任。对于负责交易处理的智能合约而言，最关键的就是如何在合适的时间以合适的价格，确保各种资产安全完成交易。

  像 Blur 这类专注于 NFT 交易的交易所，交易逻辑相对简单。卖方可以指定一个价格，授权合约进行出售，买方随后授权合约购买；或者买家出价，卖家出售，整个交易过程由智能合约保障，无需三方担保，由智能合约管理资金和资产，这就是订单薄交易所的模式。

  然而，这种模式对于 FT（同质化代币）交易来说就有些力不从心了。因为 FT 交易量大，对流动性的要求极高，需要更高效的交易模式。通过订单薄进行交易，无论是存储还是撮合等操作都需要执行合约，这会消耗大量 Gas（即区块链上执行合约所需的手续费）。

  所以，针对去中心化代币交易所，需要更高效的交易模式，也就是 AMM（自动化做市商）。从技术层面讲，AMM 就是智能合约要实现的交易逻辑，它负责处理用户交易请求、管理资金池、计算价格，并确保有足够的流动性来支撑交易。

  简单来讲，可以通过引入流动性提供者（Liquidity Provider）来实现。这些 LP 会将一对资产存入资金池，并给出初始定价。交易者无需像 NFT 交易那样等待买家，可直接在流动性池中随时买卖，而资产价格会随着持续的交易行为而变动。LP 在这个过程中能够获得相应激励。

  

### Uniswap 基本介绍

Uniswap 是以太坊上最大的去中心化交易所（DEX），我们在上一讲中提到了，Uniswap 这样的去中心化交易所采用的不是订单薄交易的方式，而是由 LP 提供流动性来交易，这个流动性池子中的代币如何定价则成为了去中心化交易所的关键。Uniswap 在其流动性池上构建了一种特定的自动做市商（AMM）机制。称为恒定乘积做市商（Constant Product Market Makers，CPMM）。顾名思义，其核心是一个非常简单的乘积公式：
$$
x∗y=k
$$
流动性池是一个持有两种不同 token 的合约， x 和 y 分别代表 token0 的数目和 token1 的数目， k 是它们的乘积，当 swap 发生时，token0 和 token1 的数量都会发生变化，但二者乘积保持不变，仍然为 k 。

另外，我们一般说的 token0 的价格是指在流动性池中相对于 token1 的价格，价格与数量互为倒数，因此公式为：
$$
P=y/x
$$
就比如说我作为 LP 在池子中放了 1 个 ETH(token0) 和 3000 个 USDT(token1)，那么 k 就是 1*3000=3000，ETH 价格就是 3000/1 = 3000U。那你作为交易方就可以把大概 30 USDT 放进去，拿出来 0.01 个 ETH。然后池子里面就变成了 3030 个 USDT 和 0.99 个 ETH，价格变 3030/0.99≈3030U。ETH 涨价了，这样是不是就解决了定价的问题，有人要换 ETH，ETH 变得稀缺，所以涨价了，下次要换 ETH 就需要更多的 USDT，只要保证池子中的 ETH * USDT 等于一个常量，这样自然就会此消彼长，当 ETH 变少时，你要通过 USDT 换取 ETH 时候就需要消耗更多 USDT，反之亦然。

当然上面的例子没有考虑滑点、手续费、取整等细节，实际合约实现时也有很多细节需要考虑。这里只是为了让大家理解基础逻辑，具体的细节会在后面展开。

Uniswap 到目前已经迭代了好几个版本，下面是各个版本的发展历程：

2018 年 11 月 Uniswap V1 发布，创新性地采用了上述 CPMM，支持 ERC-20 和 ETH 的兑换，为后续版本的 Uniswap 奠定了基础，并成为其他 AMM 协议的启示；

2020 年 5 月 Uniswap V2 发布， 在 V1 的基础上引入了 ERC-20 之间的兑换，以及时间加权平均价格（TWAP）预言机，增加交易对的灵活性，巩固了 Uniswap 在 DEX 的领先地位；

2021 年 5 月 Uniswap V3 发布，引入了集中流动性（Concentrated Liquidity），允许 LP 在交易对中定义特定的价格范围，以实现更精确的价格控制，提升了 LP 的资产利用率；

2023 年 6 月 Uniswap V4 公开了白皮书的草稿版本，引入了 Hook、Singleton、Flash Accounting 和原生 ETH 等多个优化，其中 Hook 是最重要的创新机制，给开发者提供了高度自定义性。

2025年1月Uniswap V4 发布，V4 版本在算法上并没有改变，依然还是采用集中流动性，但通过 Hooks 实现了可定制的池，单例合约和闪电记账大幅度降低了 gas 成本，对原生 ETH 的支持也同样减少了 gas，还有对动态费用的支持、ERC1155 的支持等，都大大提高了 Uniswap 的灵活性、可扩展性。